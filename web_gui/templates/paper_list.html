{% extends "base.html" %}

{% block title %}ë…¼ë¬¸ ëª©ë¡ - MCI ë…¼ë¬¸ ë°ì´í„°ë² ì´ìŠ¤{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-journal-text"></i> ë…¼ë¬¸ ëª©ë¡</h1>
            <div class="text-muted">
                ì´ {{ total_results }}í¸ì˜ ë…¼ë¬¸
            </div>
        </div>
    </div>
</div>

<!-- Filters Section -->
<div class="filter-section">
    <form id="filter-form" method="GET" action="{{ url_for('papers_list') }}">
        <input type="hidden" name="lang" value="{{ language }}">
        
        <div class="row g-3">
            <div class="col-md-3">
                <label for="category-filter" class="form-label">ì¹´í…Œê³ ë¦¬</label>
                <select name="category" id="category-filter" class="form-select">
                    <option value="all" {% if current_category == 'all' %}selected{% endif %}>ì „ì²´</option>
                    {% for category in categories %}
                    <option value="{{ category }}" {% if current_category == category %}selected{% endif %}>
                        {% if category == 'clinical_study' %}ğŸ¥ ì„ìƒì—°êµ¬
                        {% elif category == 'neuroscience' %}ğŸ§¬ ì‹ ê²½ê³¼í•™
                        {% elif category == 'biomarker' %}ğŸ”¬ ë°”ì´ì˜¤ë§ˆì»¤
                        {% elif category == 'ai_ml' %}ğŸ¤– AI/ë¨¸ì‹ ëŸ¬ë‹
                        {% elif category == 'imaging' %}ğŸ“¸ ì´ë¯¸ì§•
                        {% elif category == 'cognitive_assessment' %}ğŸ§ª ì¸ì§€í‰ê°€
                        {% else %}{{ category }}
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="year-filter" class="form-label">ë°œí–‰ì—°ë„</label>
                <select name="year" id="year-filter" class="form-select">
                    <option value="all" {% if current_year == 'all' %}selected{% endif %}>ì „ì²´</option>
                    {% for year in years %}
                    <option value="{{ year }}" {% if current_year == year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="translation-filter" class="form-label">ë²ˆì—­ìƒíƒœ</label>
                <select name="translation" id="translation-filter" class="form-select">
                    <option value="all" {% if current_translation == 'all' %}selected{% endif %}>ì „ì²´</option>
                    <option value="translated" {% if current_translation == 'translated' %}selected{% endif %}>ë²ˆì—­ì™„ë£Œ</option>
                    <option value="in_progress" {% if current_translation == 'in_progress' %}selected{% endif %}>ì§„í–‰ì¤‘</option>
                    <option value="pending" {% if current_translation == 'pending' %}selected{% endif %}>ëŒ€ê¸°ì¤‘</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="search-input" class="form-label">ê²€ìƒ‰</label>
                <input type="text" name="search" id="search-input" class="form-control" 
                       placeholder="ì œëª©, ì´ˆë¡, ì €ì ê²€ìƒ‰..." value="{{ search_query }}">
            </div>
            
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="button" id="clear-filters" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i> ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Results Section -->
{% if papers %}
<div class="row">
    {% for paper in papers %}
    <div class="col-lg-6 col-xl-4 mb-4">
        <div class="card paper-card h-100">
            <div class="card-body">
                <h6 class="card-title">
                    <a href="{{ url_for('paper_detail', paper_id=paper.id, lang=language) }}" 
                       class="paper-title text-decoration-none">
                        {{ paper.title }}
                    </a>
                </h6>
                
                <div class="paper-meta mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-journal"></i> {{ paper.journal_name }}
                        </small>
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> {{ paper.publication_year }}
                        </small>
                    </div>
                </div>
                
                <!-- Categories -->
                {% if paper.categories %}
                <div class="mb-2">
                    {% for category in paper.categories %}
                    <span class="badge 
                        {% if category.name == 'clinical_study' %}bg-primary
                        {% elif category.name == 'neuroscience' %}bg-success
                        {% elif category.name == 'biomarker' %}bg-info
                        {% elif category.name == 'ai_ml' %}bg-warning text-dark
                        {% elif category.name == 'imaging' %}bg-danger
                        {% elif category.name == 'cognitive_assessment' %}bg-secondary
                        {% else %}bg-light text-dark
                        {% endif %} me-1">
                        {% if category.name == 'clinical_study' %}ğŸ¥ ì„ìƒì—°êµ¬
                        {% elif category.name == 'neuroscience' %}ğŸ§¬ ì‹ ê²½ê³¼í•™
                        {% elif category.name == 'biomarker' %}ğŸ”¬ ë°”ì´ì˜¤ë§ˆì»¤
                        {% elif category.name == 'ai_ml' %}ğŸ¤– AI/ML
                        {% elif category.name == 'imaging' %}ğŸ“¸ ì´ë¯¸ì§•
                        {% elif category.name == 'cognitive_assessment' %}ğŸ§ª ì¸ì§€í‰ê°€
                        {% else %}{{ category.name }}
                        {% endif %}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Abstract Preview -->
                <div class="paper-abstract mb-3">
                    {% if language == 'korean' and paper.abstract_korean %}
                        {{ paper.abstract_korean[:200] }}{% if paper.abstract_korean|length > 200 %}...{% endif %}
                    {% elif paper.abstract %}
                        {{ paper.abstract[:200] }}{% if paper.abstract|length > 200 %}...{% endif %}
                    {% else %}
                        <em class="text-muted">ì´ˆë¡ì´ ì—†ìŠµë‹ˆë‹¤.</em>
                    {% endif %}
                </div>
                
                <!-- Translation Status -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="translation-status 
                        {% set status = paper.translation_status if paper.translation_status else 'pending' %}
                        {% if status == 'completed' or status == 'reviewed' %}completed
                        {% elif status == 'in_progress' %}in-progress
                        {% else %}pending
                        {% endif %}">
                        
                        {% if status == 'completed' or status == 'reviewed' %}
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <span>ë²ˆì—­ì™„ë£Œ</span>
                        {% elif status == 'in_progress' %}
                            <i class="bi bi-clock-fill text-warning"></i>
                            <span>ì§„í–‰ì¤‘</span>
                        {% else %}
                            <i class="bi bi-circle text-muted"></i>
                            <span>ëŒ€ê¸°ì¤‘</span>
                        {% endif %}
                    </div>
                    
                    <small class="text-muted">
                        PMID: {{ paper.pmid }}
                    </small>
                </div>
            </div>
            
            <div class="card-footer bg-transparent">
                <div class="d-flex gap-2">
                    <a href="{{ url_for('paper_detail', paper_id=paper.id, lang=language) }}" 
                       class="btn btn-sm btn-outline-primary flex-fill">
                        <i class="bi bi-eye"></i> ìƒì„¸ë³´ê¸°
                    </a>
                    <a href="https://pubmed.ncbi.nlm.nih.gov/{{ paper.pmid }}/" 
                       target="_blank" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-box-arrow-up-right"></i> PubMed
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination (Future Enhancement) -->
{% if papers|length >= 50 %}
<div class="row">
    <div class="col-12">
        <div class="text-center mt-4">
            <button class="btn btn-outline-primary" onclick="loadMorePapers()">
                <i class="bi bi-arrow-down-circle"></i> ë” ë§ì€ ë…¼ë¬¸ ë³´ê¸°
            </button>
        </div>
    </div>
</div>
{% endif %}

{% else %}
<!-- No Results -->
<div class="row">
    <div class="col-12">
        <div class="text-center py-5">
            <i class="bi bi-search display-1 text-muted"></i>
            <h3 class="mt-3">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-muted">
                ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„° ì¡°ê±´ì„ ì‹œë„í•´ë³´ì„¸ìš”.
            </p>
            <button type="button" id="clear-filters" class="btn btn-primary">
                <i class="bi bi-arrow-clockwise"></i> í•„í„° ì´ˆê¸°í™”
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Floating Action Button for Export -->
{% if papers %}
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    <div class="btn-group dropup">
        <button type="button" class="btn btn-success rounded-circle" 
                data-bs-toggle="dropdown" aria-expanded="false"
                data-bs-toggle="tooltip" title="ë²ˆì—­ ê´€ë¦¬">
            <i class="bi bi-translate fs-5"></i>
        </button>
        <ul class="dropdown-menu">
            <li>
                <a class="dropdown-item" href="{{ url_for('translation_management') }}">
                    <i class="bi bi-download"></i> ë²ˆì—­ìš© CSV ë‚´ë³´ë‚´ê¸°
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="{{ url_for('translation_management') }}">
                    <i class="bi bi-upload"></i> ë²ˆì—­ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
                </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item" href="{{ url_for('papers_list', translation='pending') }}">
                    <i class="bi bi-clock"></i> ë²ˆì—­ ëŒ€ê¸° ë…¼ë¬¸ë§Œ ë³´ê¸°
                </a>
            </li>
        </ul>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
function loadMorePapers() {
    // Future enhancement: AJAX pagination
    console.log('Load more papers...');
}

// Auto-submit form when filters change
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filter-form');
    const filterInputs = filterForm.querySelectorAll('select');
    
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            filterForm.submit();
        });
    });
    
    // Submit form on Enter in search input
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterForm.submit();
            }
        });
    }
});
</script>
{% endblock %}
